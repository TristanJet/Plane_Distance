{% extends "layout.html" %}

{% block title %}TeamGuesser - Play Game{% endblock %}

{% block content %}
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
    svg {
            display: block;
            margin: 0 auto;
            background: #e8f4f8;
        }
        
        .country {
            fill: #4a90e2;
            stroke: #ffffff;
            stroke-width: 0.5;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .country:hover {
            fill: #ff6b6b;
            stroke: #333;
            stroke-width: 1;
        }
        
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .zoom-controls{
            position: absolute;
            bottom: 20px;       /* Distance from bottom */
            right: 20px;        /* Distance from right */
            display: flex;
            flex-direction: column; /* Stack them vertically */
            gap: 5px;           /* Space between buttons */
            z-index: 100;
        }
        .zoom-btn {
            background-color: white;
            border: 1px solid #ccc;
            color: #333;
            width: 30px;
            height: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .zoom-btn:hover {
            background-color: #f0f0f0;
        }
        </style>

    <div class="game-container">
        <!-- Map Section -->
        <div class="map-section">
            <div id="map" class="game-map"></div>
            <div id="country-info">
                <p style="color: #666;"><em>Hover over a country to see its name.</em></p>
            </div>
            <div class="zoom-controls">
                <button id="zoom_in" class="zoom-btn">+</button>
                <button id="zoom_out" class="zoom-btn">-</button>
            </div>
        </div>
        

        

        
        <!-- Game Info Bar -->
        <div class="game-info-bar">
            <div class="info-item">
                <span class="info-label">Round</span>
                <span class="info-value" id="round"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Score</span>
                <span class="info-value" id="score"></span>
            </div>
        </div>

        <!-- Question and Answer Section -->
        <div class="question-section">
            <div class="question-card card">
                <h2 class="question-title">What is the distance between these two airports?</h2>
                
                <div class="airports-info">
                    <div class="airport">
                        <div class="airport-icon">üõ´</div>
                        <div class="airport-name" id="airport1">Helsinki Airport (HEL)</div>
                    </div>
                    <div class="distance-arrow">‚û°Ô∏è</div>
                    <div class="airport">
                        <div class="airport-icon">üõ¨</div>
                        <div class="airport-name" id="airport2">London Heathrow (LHR)</div>
                    </div>
                </div>

                <div class="answer-section">
                    <div class="input-group">
                        <input 
                            type="number" 
                            id="distanceInput" 
                            class="distance-input" 
                            placeholder="Enter distance"
                            min="0"
                            step="1"
                        >
                        <span class="input-unit">km</span>
                    </div>
                    
                    <button class="btn btn-primary btn-submit" onclick="submitAnswer()">
                        Submit Answer
                    </button>
                </div>
            </div>
        </div>
        <div class="tooltip" id="tooltip"></div>
    </div>
   
    <script>
        const width = 1000;
        const height = 750;
        console.log('line 71')

        // Projection configuration
        const projection = d3.geoMercator()
            .scale(150)
            .translate([width / 2, height / 1.7]);

        let svg, path, countries;

        function createMap(projection) {
            // Clear existing map
            d3.select('#map').selectAll('*').remove();
            //console.log(d3.select('#map').selectAll('*').remove())

            // Create SVG
            svg = d3.select('#map')
                .append('svg')
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr('width', width)
                .attr('height', height);

            // Group for zooming
            const g = svg.append('g');

            const mapLayer = g.append('g').attr('class', 'map-layer');
            const gameLayer = g.append('g').attr('class', 'game-layer');

            // Define zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([1, 10]) // Limit zoom: 1x to 8x
                .translateExtent([[0, 0], [width, height]]) // Limit panning to map edges
                .on('zoom', function(event) {
                    // Apply move + scale to the g
                    g.attr('transform', event.transform);

                    // Keep country borders thin
                    g.selectAll('.country').style('stroke-width', 1 / event.transform + 'px');

                    // Keep markers to stay small
                    g.selectAll('.poi-market').attr('r', 6 / event.transform.k)
                });
            // Attach Zoom to svg
            svg.call(zoom);

            // Connect Zoom buttons
            // Zoom In
            d3.select('#zoom_in').on('click', function() {
                svg.transition().duration(750).call(zoom.scaleBy, 1.3);
            });

            // Zoom Out
            d3.select('#zoom_out').on('click', function() {
                svg.transition().duration(750).call(zoom.scaleBy, 1 / 1.3)
                
            });

            
            // Path generator
            path = d3.geoPath().projection(projection);

            

            // Tooltip
            const tooltip = d3.select('#tooltip');

            // Load and render world data
            d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json')
                .then(data => {
                    // Convert TopoJSON to GeoJSON
                    const countriesData = topojson.feature(data, data.objects.countries);

                    // Create a group for each country (individual SVG element)
                    countries = mapLayer.selectAll('.country')
                        .data(countriesData.features)
                        .enter()
                        .append('path')
                        .attr('class', 'country')
                        .attr('d', path)
                        .attr('data-country-id', d => d.id)
                        .attr('data-country-name', d => d.properties.name)
                        .on('mouseover', function(event, d) {
                            tooltip
                                .style('opacity', 1)
                                .html(`<strong>${d.properties.name}</strong>`)
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mousemove', function(event) {
                            tooltip
                                .style('left', (event.pageX + 10) + 'px')
                                .style('top', (event.pageY - 10) + 'px');
                        })
                        .on('mouseout', function() {
                            tooltip.style('opacity', 0);
                        });

                    console.log(`Rendered ${countriesData.features.length} individual country SVG paths`);
                    //console.log(`Using projection ${projection}`)
                })
        }

        // Initialize map
        createMap(projection)
        console.log('=== World Map SVG Structure ===');



    </script>
{% endblock %}